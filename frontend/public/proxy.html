<!DOCTYPE html>
<html>
<head>
  <title>WebSocket Proxy</title>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <script>
    // This proxy allows secure communication between the HTTPS Amplify app and HTTP WebSocket
    window.addEventListener('message', function(event) {
      // Only accept messages from our Amplify app
      if (event.origin !== window.location.origin) return;
      
      const data = event.data;
      
      if (data.type === 'SOCKET_INIT') {
        // Initialize socket connection to the WebSocket server
        const socket = io(data.url, {
          transports: ['websocket'],
          reconnection: true
        });
        
        // Forward socket events back to the parent window
        socket.on('connect', () => {
          window.parent.postMessage({ type: 'SOCKET_CONNECTED' }, '*');
        });
        
        socket.on('disconnect', () => {
          window.parent.postMessage({ type: 'SOCKET_DISCONNECTED' }, '*');
        });
        
        socket.on('error', (error) => {
          window.parent.postMessage({ type: 'SOCKET_ERROR', error }, '*');
        });
        
        socket.on('nova-started', (data) => {
          window.parent.postMessage({ type: 'NOVA_STARTED', data }, '*');
        });
        
        socket.on('text-message', (data) => {
          window.parent.postMessage({ type: 'TEXT_MESSAGE', data }, '*');
        });
        
        socket.on('audio-chunk', (data) => {
          window.parent.postMessage({ type: 'AUDIO_CHUNK', data }, '*');
        });
        
        // Store socket in window for future use
        window.socket = socket;
      }
      
      // Handle other socket events
      if (data.type === 'SOCKET_EMIT' && window.socket) {
        window.socket.emit(data.event, data.payload);
      }
    });
    
    // Notify parent that proxy is ready
    window.parent.postMessage({ type: 'PROXY_READY' }, '*');
  </script>
</head>
<body>
  <h1>WebSocket Proxy</h1>
  <p>This page serves as a proxy for WebSocket connections.</p>
</body>
</html>