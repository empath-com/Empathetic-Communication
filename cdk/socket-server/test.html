<!DOCTYPE html>
<html>
<head>
    <title>Nova Sonic Audio Test</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px; margin: 5px; }
        #log { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Nova Sonic Audio Test</h1>
    
    <div>
        <button id="connectBtn">Connect</button>
        <button id="startNovaBtn" disabled>Start Nova</button>
        <button id="sendAudioBtn" disabled>Send Test Audio</button>
        <button id="endAudioBtn" disabled>End Audio</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
    </div>
    
    <div id="log"></div>
    
    <script>
        const log = document.getElementById('log');
        const connectBtn = document.getElementById('connectBtn');
        const startNovaBtn = document.getElementById('startNovaBtn');
        const sendAudioBtn = document.getElementById('sendAudioBtn');
        const endAudioBtn = document.getElementById('endAudioBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        
        let socket;
        let audioPlayer = new Audio();
        
        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        connectBtn.addEventListener('click', () => {
            const serverUrl = prompt('Enter socket server URL:', 'http://localhost:3000');
            if (!serverUrl) return;
            
            try {
                socket = io(serverUrl);
                
                socket.on('connect', () => {
                    addLog('Connected to socket server', 'success');
                    connectBtn.disabled = true;
                    startNovaBtn.disabled = false;
                    disconnectBtn.disabled = false;
                });
                
                socket.on('disconnect', () => {
                    addLog('Disconnected from socket server', 'error');
                    resetButtons();
                });
                
                socket.on('error', (error) => {
                    addLog(`Socket error: ${error}`, 'error');
                });
                
                socket.on('nova-started', (data) => {
                    addLog(`Nova started: ${data.status}`, 'success');
                    sendAudioBtn.disabled = false;
                });
                
                socket.on('audio-chunk', (data) => {
                    const audioSize = data.data ? data.data.length : 0;
                    addLog(`Received audio chunk, size: ${audioSize}`, 'info');
                    
                    if (data.data) {
                        try {
                            // Convert base64 to ArrayBuffer
                            const binaryString = window.atob(data.data);
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            
                            // Create blob and play
                            const blob = new Blob([bytes.buffer], { type: 'audio/wav' });
                            const url = URL.createObjectURL(blob);
                            audioPlayer.src = url;
                            audioPlayer.play();
                            addLog('Playing audio...', 'info');
                        } catch (error) {
                            addLog(`Error playing audio: ${error}`, 'error');
                        }
                    }
                });
                
                socket.on('text-message', (data) => {
                    addLog(`Received text: ${data.text}`, 'info');
                });
                
            } catch (error) {
                addLog(`Connection error: ${error}`, 'error');
            }
        });
        
        startNovaBtn.addEventListener('click', () => {
            socket.emit('start-nova-sonic');
            addLog('Starting Nova Sonic...', 'info');
            startNovaBtn.disabled = true;
        });
        
        sendAudioBtn.addEventListener('click', () => {
            // Generate a simple sine wave (1 second of 440Hz tone)
            const sampleRate = 16000;
            const duration = 1.0; // seconds
            const frequency = 440; // Hz
            
            const audioBuffer = new ArrayBuffer(sampleRate * 2); // 16-bit samples = 2 bytes per sample
            const view = new DataView(audioBuffer);
            
            for (let i = 0; i < sampleRate; i++) {
                const value = Math.sin(2 * Math.PI * frequency * i / sampleRate) * 32767;
                view.setInt16(i * 2, value, true); // true = little endian
            }
            
            // Convert to base64
            const bytes = new Uint8Array(audioBuffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            const base64 = window.btoa(binary);
            
            // Send to server
            socket.emit('audio-input', { data: base64 });
            addLog(`Sent test audio, size: ${audioBuffer.byteLength} bytes`, 'info');
            endAudioBtn.disabled = false;
            sendAudioBtn.disabled = true;
        });
        
        endAudioBtn.addEventListener('click', () => {
            socket.emit('end-audio');
            addLog('Ended audio input', 'info');
            endAudioBtn.disabled = true;
            sendAudioBtn.disabled = false;
        });
        
        disconnectBtn.addEventListener('click', () => {
            socket.disconnect();
            resetButtons();
            addLog('Manually disconnected', 'info');
        });
        
        function resetButtons() {
            connectBtn.disabled = false;
            startNovaBtn.disabled = true;
            sendAudioBtn.disabled = true;
            endAudioBtn.disabled = true;
            disconnectBtn.disabled = true;
        }
    </script>
</body>
</html>